### 1. 项目目的

`MyHelper`项目的核心目标是创建一个**轻量化、自包含的异步智能任务平台**。它旨在解决复杂的、多步骤的自动化业务场景，而不是作为通用的编程或系统操作助理。

其主要应用场景包括：

- **SRE（网站可靠性工程）应急预案自动化**：例如在收到告警后，自动执行一系列诊断和恢复流程。
    
- **周期性业务数据分析与报告生成**：例如，每周自动拉取销售数据，进行分析，并生成图文并茂的报告。
    
- **跨系统业务流程整合**：将需要调用多个不同服务的复杂工作流自动化。
    

该平台的核心能力是接收用户以**自然语言**定义的高层次目标，通过内部的**智能体（Agent）协作**，将目标分解、规划，并调用外部的**MCP（Model Context Protocol）服务**来执行具体任务。最终，它不仅完成任务，还能**自动生成结构化的可视化报告**，并通过多种渠道**主动推送**给相关人员，整个过程通过一个开放的Web界面进行监控与配置。

### 2. 技术栈

该设计文档在理念上是**语言和框架无关**的，并未强制指定具体的编程语言或Web框架（如Rust或Axum）。它侧重于描述组件的职责和交互模式，这使得该设计可以用多种技术栈来实现。不过，文档中提到的“异步”、“工作线程”、“文件锁”等概念，非常契合使用像Rust + Tokio这样的高性能异步语言。

根据文档描述，一个典型的技术选型可能包含：

- **核心逻辑**: 任何支持高级异步编程和并发的语言（如Rust, Go, Python）。
    
- **Web后端**: 任何能够提供RESTful API和托管静态文件的Web框架。
    
- **Web前端**: 一个现代的单页应用（SPA）框架，如React, Vue或Svelte。
    
- **持久化**: **本地文件系统**。这是该项目的一个关键特征，明确排除了对外部数据库（如PostgreSQL, Redis）的依赖。
    
- **外部依赖**:
    
    - **大语言模型 (LLM) 服务**: 用于任务规划和分解。
        
    - **MCP服务**: 用于执行具体的工具调用。
        

### 3. 设计文档

#### 3.1 核心设计原则

1. **可视化与可交互性**: 所有系统状态（任务进度、历史、配置）都通过Web UI直观展示，包括任务结果的可视化报告，旨在降低使用门槛和简化调试。
    
2. **标准化与定制化平衡**: 系统能自动生成**结构固定的HTML报告**，确保内容的一致性；同时允许用户通过**注入自定义CSS**文件来实现视觉上的灵活定制，达到开箱即用与个性化需求的平衡。
    
3. **主动交付**: 任务完成后，系统能通过邮件、Slack等渠道**主动推送结果和报告链接**，改变了传统需要用户反复轮询检查状态的被动模式。
    
4. **简洁性 (无登录)**: 假设系统部署在受信任的内部网络，**移除了用户登录逻辑**，极大地简化了部署和使用体验。
    
5. **自包含 (无外部数据库)**: 核心功能**不依赖外部数据库或消息队列**，作为一个独立单元运行，简化了安装和维护。
    
6. **持久性**: 所有任务状态和配置都**通过文件系统持久化**，应用重启或崩溃后能自动恢复，保证任务不丢失。
    
7. **模块化与可扩展性**: 前后端分离，核心功能高度解耦。添加新的通知渠道或支持新的工具仅需开发独立模块，不影响核心代码。
    

#### 3.2 系统架构

系统在逻辑上分为四层，通过一个清晰定义的工作流进行协作：

1. **Web应用层**: 包含**前端UI**和**后端BFF API**。用户通过UI监控和创建任务，后端API负责服务前端、托管静态报告页面，并接收任务请求。
    
2. **核心服务层**: 这是系统的大脑，包含一系列协同工作的管理器：
    
    - `MissionManager`: 负责任务数据的持久化读写。
        
    - `QueueManager`: 负责管理持久化的任务队列。
        
    - `Worker`: 核心工作线程，驱动任务的整个生命周期。
        
    - `LLMManager` & `ToolManager`: 分别作为与外部LLM和MCP服务交互的统一网关。
        
    - `ReportGenerator` & `NotificationManager`: 负责报告生成和结果推送。
        
3. **持久化层**: 完全基于**本地文件系统**，存储任务数据、队列状态、系统配置、CSS样式文件和生成的HTML报告。
    
4. **外部依赖**: 包括LLM服务和MCP服务。
    

#### 3.3 核心数据实体 (`Mission`)

`Mission`是流转于系统内部的核心数据结构，它记录了任务从创建到完成的所有信息。其关键字段包括：

- **`mission_id`**: 任务的唯一ID。
    
- **`natural_language_goal`**: 用户输入的原始自然语言目标。
    
- **`subtask_graph`**: 由编排Agent生成的结构化子任务列表，是任务执行的“蓝图”，包含了每个步骤的依赖、状态和结果。
    
- **`report_config`**: 一个可选对象，用于标记此任务需要生成报告，并可指定使用的CSS样式文件名。
    
- **`notification_config`**: 一个可选数组，定义了任务完成后需要通过哪些渠道将结果推送给谁。
    
- **`result_page_url`**: 报告生成后，系统回填的、可供访问的报告页面URL。
    

### 4. 具体实现

文档对关键组件和工作流程的实现方式给出了明确的指引。

#### 4.1 核心工作流程

1. **入队**: 任务通过API或定时器创建后，其ID被`QueueManager`放入一个代表“待处理”的目录中。
    
2. **出队与锁定**: `Worker`线程通过对文件系统的**原子性移动操作**（例如，将任务文件从`pending/`目录移动到`processing/{worker_id}/`目录）来获取任务的所有权。这种方式避免了复杂的分布式锁，实现了一个简单而健壮的队列。
    
3. **规划与执行**: `Worker`首先调用**编排Agent**与LLM通信，将用户的自然语言目标转化为`subtask_graph`。然后，`Worker`充当项目经理，根据子任务图的依赖关系，调度不同的**专用子Agent**去执行。子Agent通过`ToolManager`调用外部MCP服务。
    
4. **报告生成与渲染**: 当所有子任务执行完毕后，如果`report_config`存在，`Worker`会调用`ReportGenerator`。这个生成器以编程方式创建一个**结构固定的HTML文件**，并**链接上用户指定的CSS文件**。这份报告随后被保存在一个可通过Web访问的公共目录中。
    
5. **通知与归档**: `Worker`调用`NotificationManager`，后者根据`notification_config`中的配置，选择相应的驱动（如`EmailDriver`）发送包含结果摘要和报告URL的消息。任务完成后，其状态被更新，并从处理队列中移除。
    

#### 4.2 关键组件实现细节

- **持久化机制**:
    
    - `MissionManager`在读写任务数据文件时，会使用**文件锁（`flock`）**来保证操作的原子性和并发安全，防止数据损坏。
        
    - `QueueManager`通过在不同状态目录（如`pending`, `processing`, `completed`）之间移动任务文件来实现队列状态的变更，操作既原子又直观。
        
- **报告与样式定制**:
    
    - `ReportGenerator`的实现是该系统的一大亮点。它不使用模板引擎，而是以编程方式生成HTML，确保了**所有报告共享完全一致的DOM结构和class名称**。
        
    - 这使得用户或管理员可以非常轻松地通过提供不同的CSS文件来彻底改变报告的外观，而无需触及任何后端代码。前端UI会通过一个API（如 `GET /api/styles`）动态扫描`styles/`目录，并将可用的样式作为下拉菜单选项呈现给用户。
        
- **安全模型**:
    
    - 系统在设计上明确**假定其运行在受信任的内部网络中**，因此**不设用户认证和登录机制**。
        
    - 安全重心放在了对内部操作和外部调用的管控上：`ToolManager`统一管理对MCP服务的调用认证；`ConfigManager`在保存新配置前进行严格校验，防止错误配置导致系统故障。
        
- **可扩展性**:
    
    - **通知渠道**: `NotificationManager`采用**驱动模式**，添加新渠道（如钉钉）只需实现一个新的`DingTalkDriver`并注册即可。
        
    - **工具支持**: `ToolManager`可以方便地注册新的MCP服务信息，供`Agent`调用。